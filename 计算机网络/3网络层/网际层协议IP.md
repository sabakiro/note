与IP协议配套使用的还有三个协议：
1. 地址解析协议ARP (Address Resolution Protocol)
2. 网际控制报文协议ICMP (Internet Control Message Protocol)
3. 网际组管理协议IGMP (Internet Group Management Protocol)

#### 虚拟互连网络
###### 网络相连的中间设备
1. 物理层使用的中间设备叫做转发器(repeater)。
2. 数据链路层使用的中间设备叫做网桥或桥接器(bridge)。
3. 网络层使用的中间设备叫做路由器(router)。
4. ) 在网络层以上使用的中间设备叫做网关(gateway)。用网关连接两个不兼容的系统需要在高层进行协议的转换。

#### 分类的IP地址

ip共32位
1. A类地址：0| 网络号 | 【主机号（24位）】
2. B类地址：10|网络号|【主机号（16位）】
3. C类地址：110|网络号|【主机号（8位）】
4. D类地址：1110 | 多播地址
5. E类地址：1111 |  保留为今后使用

1. A类、B类和C类地址的网络号字段（在图中这个字段是灰色的）分别为1，2和3字节长，而在网络号字段的最前面有1∼3位的类别位，其数值分别规定为0，10和110。
2. A类、B类和C类地址的主机号字段分别为3个、2个和1个字节长
3. D类地址（前4位是1110）用于多播（一对多通信）
4. E类地址（前4位是1111）保留为以后用。
5. IP地址并不仅仅指明一个主机，而是还指明了主机所连接到的网络。

#### A类地址
###### 网络号
1. A类地址的网络号字段占一个字节，只有7位可供使用（该字段的第一位已固定为0），但可指派的网络号是126个（即2^7 - 2）。
2. 减2的原因是：第一，IP地址中的全0表示“这个(this)”。网络号字段为全0的IP地址是个保留地址，意思是“本网络”。
3. 第二，网络号为127（即01111111）保留作为本地软件环回测试(loopback test)本主机的进程之间的通信之用。
4. 若主机发送一个目的地址为环回地址（例如127.0.0.1）的IP数据报，则本主机中的协议软件就处理数据报中的数据，而不会把数据报发送到任何网络。
5. 目的地址为环回地址的IP数据报永远不会出现在任何网络上，因为网络号为127的地址根本不是一个网络地址。
###### 主机号
1. A类地址的主机号占3字节，因此每一个A类网络中的最大主机数是2^24 - 2，即16777 214。
2. 这里减2的原因是：
	1. 全0的主机号字段表示该IP地址是“本主机”所连接到的单个网络地址（例如，一主机的IP地址为5.6.7.8，则该主机所在的网络地址就是5.0.0.0），
	2. 而全1表示“所有的(all)”，因此全1的主机号字段表示该网络上的所有主机。
3. IP地址空间共有2^32（即4 294 967 296）个地址。
4. 整个A类地址空间共有2^31个地址，占有整个IP地址空间的50%。

#### B类地址
1. B类地址的网络号字段有2字节，但前面两位（10）已经固定了()，只剩下14位可以进行分配。
2. 因为网络号字段后面的14位无论怎样取值也不可能出现使整个2字节的网络号字段成为全0或全1，因此这里不存在网络总数减2的问题。
3. 但实际上B类网络地址128.0.0.0是不指派的，而可以指派的B类最小网络地址是`128.1.0.0`。
4. 因此B类地址可指派的网络数为2^14 - 1，即16 383。
5. B类地址的每一个网络上的最大主机数是2^16 - 2，即65 534。
	1. 这里需要减2是因为要扣除全0和全1的主机号。
6. 整个B类地址空间共约有2^30个地址，占整个IP地址空间的25%。

###### C类地址
1. C类地址有3个字节的网络号字段，最前面的3位是（1 10），还有21位可以进行分配。
2. C类网络地址192.0.0.0也是不指派的，可以指派的C类最小网络地址是`192.0.1.0 `，因此C类地址可指派的网络总数是2^21 - 1，即2097 151。
3. 每一个C类地址的最大主机数是2^8 - 2，即254。
4. 整个C类地址空间共约有2^29个地址，占整个IP地址的12.5%。

##  IP地址与硬件地址
1. 物理地址是数据链路层和物理层使用的地址，
2. 而IP地址是网络层和以上各层使用的地址，
	1. 是一种逻辑地址（称IP地址是逻辑地址是因为IP地址是用软件实现的）。
3. 连接在通信链路上的设备（主机或路由器）在接收MAC帧时，其根据是MAC帧首部中的硬件地址。
4. 在数据链路层看不见隐藏在MAC帧的数据中的IP地址。
5. 只有在剥去MAC帧的首部和尾部后把MAC层的数据上交给网络层后，网络层才能在IP数据报的首部中找到源IP地址和目的IP地址。
6. P 地址放在 IP 数据报的首部，而硬件地址则放在 MAC 帧的首部。
7. 在网络层和网络层以上使用的是 IP 地址，而数据链路层及以下使用的是硬件地址
8. 当IP数据报放入数据链路层的MAC帧中以后，整个的IP数据报就成为MAC帧的数据，因而在数据链路层看不见数据报的IP地址。
9. 虽然在IP数据报首部有源站IP地址，但路由器只根据目的站的IP地址的网络号进行路由选择。
10. 在IP层抽象的互联网上只能看到IP数据报。虽然IP数据报要经过路由器R1和R2的两次转发，但在它的首部中的源地址和目的地址始终分别是IP1和IP2
11. 在局域网的链路层，只能看见MAC帧。IP数据报被封装在MAC帧中。MAC帧在不同网络上传送时，其MAC帧首部中的源地址和目的地址要发生变化

#### 地址解析协议ARP
ARP协议的用途是为了从网络层使用的IP地址解析出在数据链路层使用的硬件地址

1. 但IP地址和下面的网络的硬件地址之间由于格式不同而不存在简单的映射关系（例如，IP地址有32位，而局域网的硬件地址是48位）。
2. 此外，在一个网络上可能经常会有新的主机加入进来，或撤走一些主机。
3. 更换网络适配器也会使主机的硬件地址改变。
4. 地址解析协议ARP解决这个问题的方法是在主机ARP高速缓存中应存放一个从IP地址到硬件地址的映射表，并且这个映射表还经常动态更新（新增或超时删除）
5. 每一个主机都设有一个ARP高速缓存(ARP cache)，里面有本局域网上的各主机和路由器的IP地址到硬件地址的映射表

1. 当主机A要向本局域网上的某个主机B发送IP数据报时，就先在其ARP高速缓存中查看有无主机B的IP地址。
	1. 如有，就在ARP高速缓存中查出其对应的硬件地址，再把这个硬件地址写入MAC帧，然后通过局域网把该MAC帧发往此硬件地址
	2. 也有可能查不到主机B的IP地址的项目。这可能是主机B才入网，也可能是主机A刚刚加电，其高速缓存还是空的。在这种情况下，主机A就自动运行ARP, 然后按以下步骤找出主机B的硬件地址。
		1. ARP进程在本局域网上广播发送一个ARP请求分组，ARP请求分组的主要内容是：“我的IP地址是209.0.0.5，硬件地址是00-00-C0-15-AD-18。我想知道IP地址为209.0.0.6的主机的硬件地址
		2. 在本局域网上的所有主机上运行的ARP进程都收到此ARP请求分组。
		3. 主机B的IP地址与ARP请求分组中要查询的IP地址一致，就收下这个ARP请求分组，并向主机A发送ARP响应分组，并在这个ARP响应分组中写入自己的硬件地址。
		4. 由于其余的所有主机的IP地址都与ARP请求分组中要查询的IP地址不一致，因此都不理睬这个ARP请求分组。ARP响应分组的主要内容是表明：“我的IP地址是209.0.0.6，我的硬件地址是08-00-2B-00-EE-0A。”
			1. 请注意：虽然ARP请求分组是广播发送的，但ARP响应分组是普通的单播，即从一个源地址发送到一个目的地址。
		5. 主机A收到主机B的ARP响应分组后，就在其ARP高速缓存中写入主机B的IP地址到硬件地址的映射。
2. 当主机A向B发送数据报时，很可能以后不久主机B还要向A发送数据报，因而主机B也可能要向A发送ARP请求分组。为了减少网络上的通信量，主机A在发送其ARP请求分组时，就把自己的IP地址到硬件地址的映射写入ARP请求分组。当主机B收到A的ARP请求分组时，就把主机A的这一地址映射写入主机B自己的ARP高速缓存中。以后主机B向A发送数据报时就很方便了。
3. ARP把保存在高速缓存中的每一个映射地址项目都设置生存时间（例如，10～20分钟）。凡超过生存时间的项目就从高速缓存中删除掉
4. 使用ARP的四种典型情况
	1. 发送方是主机（如H1），要把IP数据报发送到同一个网络上的另一个主机（如H2）。这时H1发送ARP请求分组（在网1上广播），找到目的主机H2的硬件地址。
	2. 发送方是主机（如H1），要把IP数据报发送到另一个网络上的一个主机（如H3或H4）。这时H1发送ARP请求分组（在网1上广播），找到网1上的一个路由器R1的硬件地址。剩下的工作由路由器R1来完成。
	3. 发送方是路由器（如R1），要把IP数据报转发到与R1连接在同一个网络（网2）上的主机（如H3）。这时R1发送ARP请求分组（在网2上广播），找到目的主机H3的硬件地址。
	4. 发送方是路由器（如R1），要把IP数据报转发到网3上的一个主机（如H4）。H4与R1不是连接在同一个网络上。这时R1发送ARP请求分组（在网2上广播），找到连接在网2上的一个路由器R2的硬件地址。剩下的工作由这个路由器R2来完成。
## IP数据报的格式
一个IP数据报由首部和数据两部分组成。首部的前一部分是固定长度，共20字节，是所有IP数据报必须具有的。在首部的固定部分的后面是一些可选字段，其长度是可变的


## IP层转发分组的流程
分组转发算法如下：
1. 从数据报的首部提取目的主机的IP地址D, 得出目的网络地址为N。
2. 若N就是与此路由器直接相连的某个网络地址，则进行直接交付，不需要再经过其他的路由器，直接把数据报交付目的主机（这里包括把目的主机地址 D 转换为具体的硬件地址，把数据报封装为MAC帧，再发送此帧）；否则就是间接交付，执行(3)。
3. 若路由表中有目的地址为D的特定主机路由，则把数据报传送给路由表中所指明的下一跳路由器；否则，执行(4)。
4. 若路由表中有到达网络N的路由，则把数据报传送给路由表中所指明的下一跳路由器；否则，执行(5)。
5. 若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；否则，执行(6)。
6. (6) 报告转发分组出错。